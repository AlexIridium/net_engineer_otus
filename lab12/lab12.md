# Лабораторная работа - Настройка NAT для IPv4

### Топология

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_00.JPG)

### Таблица адресации

| Устройство | Интерфейс | IP-адрес | Маска подсети |
| --- | --- | --- | --- |
| R1 | G0/0/0 | 209.165.200.230 | 255.255.255.248 |
| R1 | G0/0/1 | 192.168.1.1 | 255.255.255.0 |
| R2 | G0/0/0 | 209.165.200.225 | 255.255.255.248 |
| R2 | Lo1 | 209.165.200.1 | 255.255.255.224 |
| S1 | VLAN 1 | 192.168.1.11 | 255.255.255.0 |
| S2 | VLAN 1 | 192.168.1.12 | 255.255.255.0 |
| PC-A | NIC | 192.168.1.2 | 255.255.255.0 |
| PC-B | NIC | 192.168.1.3 | 255.255.255.0 |


## Цели

### Часть 1. Создание сети и настройка основных параметров устройства

### Часть 2. Настройка и проверка NAT для IPv4

### Часть 3. Настройка и проверка PAT для IPv4

### Часть 4. Настройка и проверка статического NAT для IPv4.



### Часть 1. Создание сети и настройка основных параметров устройства

В первой части лабораторной работы вам предстоит создать топологию сети и настроить базовые параметры для узлов ПК и коммутаторов.

#### Шаг 1. Подключите кабели сети согласно приведенной топологии.

Подключите устройства в соответствии с топологией и подсоедините соответствующие кабели. Скрин ниже.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_01.JPG)


#### Шаг 2. Произведите базовую настройку маршрутизаторов.

a.	Назначьте маршрутизатору имя устройства.

b.	Отключите поиск DNS, чтобы предотвратить попытки маршрутизатора неверно преобразовывать введенные команды таким образом, как будто они являются именами узлов.

c.	Назначьте class в качестве зашифрованного пароля привилегированного режима EXEC.

d.	Назначьте cisco в качестве пароля консоли и включите вход в систему по паролю.

e.	Назначьте cisco в качестве пароля VTY и включите вход в систему по паролю.

f.	Зашифруйте открытые пароли.

g.	Создайте баннер с предупреждением о запрете несанкционированного доступа к устройству.

h.	Настройте IP-адресации интерфейса, как указано в таблице выше.

i.	Настройте маршрут по умолчанию. от R2 до  R1.

j.	Сохраните текущую конфигурацию в файл загрузочной конфигурации.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_09.JPG)


#### Шаг 3. Настройте базовые параметры каждого коммутатора.

a.	Присвойте коммутатору имя устройства.

b.	Отключите поиск DNS, чтобы предотвратить попытки маршрутизатора неверно преобразовывать введенные команды таким образом, как будто они являются именами узлов.

c.	Назначьте class в качестве зашифрованного пароля привилегированного режима EXEC.

d.	Назначьте cisco в качестве пароля консоли и включите вход в систему по паролю.

e.	Назначьте cisco в качестве пароля VTY и включите вход в систему по паролю.

f.	Зашифруйте открытые пароли.

g.	Создайте баннер с предупреждением о запрете несанкционированного доступа к устройству.

h.	Выключите все интерфейсы, которые не будут использоваться.

i.	Настройте IP-адресации интерфейса, как указано в таблице выше.

j.	Сохраните текущую конфигурацию в файл загрузочной конфигурации.

Для S1:

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_03.JPG)

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_04.JPG)

Для S2:

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_05.JPG)

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_06.JPG)

Конфигурация PC-A, PC-B:

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_07.JPG)


### Часть 2. Настройка и проверка NAT для IPv4.

В части 2 необходимо настроить и проверить NAT для IPv4.

#### Шаг 1. Настройте NAT на R1, используя пул из трех адресов 209.165.200.226-209.165.200.228

a.	Настройте простой список доступа, который определяет, какие хосты будут разрешены для трансляции. В этом случае все устройства в локальной сети R1 имеют право на трансляцию. Скриншот ниже.

*R1(config)# access-list 1 permit 192.168.1.0 0.0.0.255*


b.	Создайте пул NAT и укажите ему имя и диапазон используемых адресов. Скриншот ниже.

*R1(config)# ip nat pool PUBLIC_ACCESS 209.165.200.226 209.165.200.228 netmask 255.255.255.248*

Примечание. Параметр маски сети не является разделителем IP-адресов. Это должна быть правильная маска подсети для назначенных адресов, даже если вы используете не все адреса подсети в пуле. 

c.	Настройте перевод, связывая ACL и пул с процессом преобразования. Скриншот ниже.

*R1(config)# ip nat inside source list 1 pool PUBLIC_ACCESS*

Примечание: Три очень важных момента. Во-первых, слово «inside» имеет решающее значение для работы такого рода NAT. Если вы опустить его, NAT не будет работать. Во-вторых, номер списка — это номер ACL, настроенный на предыдущем шаге. В-третьих, имя пула чувствительно к регистру. 

d.	Задайте внутренний (inside) интерфейс. Скриншот ниже.

*R1(config)# interface g0/0/1*
*R1(config-if)# ip nat inside*

e.	Определите внешний (outside) интерфейс. Скриншот ниже.

*R1(config)# interface g0/0/0*
*R1(config-if)# ip nat outside*

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_08.JPG)


#### Шаг 2. Проверьте  конфигурацию. 

a.	С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните процес поиска и устранения неполадок. На R1 отобразите таблицу NAT на R1 с помощью команды *show ip nat translations.*

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_10.JPG)

*Вопрос: Во что был транслирован внутренний локальный адрес PC-B?*

*Ответ: Внутренний локальный адрес транслирован во внутренний глобальный адрес 209.165.200.226*

*Вопрос: Какой тип адреса NAT является переведенным адресом?*

*Ответ: Динамический NAT*



b.	С PC-A, запустите  эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды *show ip nat translations*.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_11.JPG)



c.	Обратите внимание, что предыдущая трансляция для PC-B все еще находится в таблице. Из S1, эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_12.JPG)


d.	Теперь запускаем пинг R2 Lo1 из S2. На этот раз перевод завершается неудачей, и вы получаете эти сообщения (или аналогичные) на консоли R1:

В моей версии Cisco PT отобразилось следующее:

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_13.JPG)


e.	Это ожидаемый результат, потому что выделено только 3 адреса, и мы попытались ping Lo1 с четырех устройств. Напомним, что NAT — это трансляция «один-в-один». Введите команду show ip nat translations verbose , и вы увидите, что ответ будет 24 часа.

Команда *show ip nat translations verbose* отсутствует в моей версии Cisco PT.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_14.JPG)

f.	Учитывая, что пул ограничен тремя адресами, NAT для пула адресов недостаточно для нашего приложения. Очистите преобразование NAT и статистику.

Не все команды из лабораторной работы реализованы в моей версии Cisco PT.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_15.JPG)


### Часть 3. Настройка и проверка PAT для IPv4.

В части 3 необходимо настроить замену NAT на PAT в пул адресов, а затем на PAT с помощью интерфейса.

Компоненты конфигурации преобразования адресов в основном одинаковы; что-то (список доступа) для идентификации адресов, пригодных для перевода, дополнительно настроенный пул адресов для их преобразования и команды, необходимые для идентификации внутреннего и внешнего интерфейсов. Из части 1 наш список доступа (список доступа 1) по-прежнему корректен для сетевого сценария, поэтому нет необходимости воссоздавать его. Мы будем использовать один и тот же пул адресов, поэтому нет необходимости воссоздавать эту конфигурацию. Кроме того, внутренний и внешний интерфейсы не меняются. Чтобы начать работу в части 3, удалите команду, связывающую ACL и пул вместе.

#### Шаг 2. Добавьте команду PAT на R1.

Теперь настройте преобразование PAT в пул адресов (помните, что ACL и Pool уже настроены, так что это единственная команда, которую нам нужно изменить с NAT на PAT). скрин ниже.

#### Шаг 3. Протестируйте и проверьте конфигурацию.

a.	Давайте проверим, что PAT работает. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды *show ip nat translations.*


![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_16.JPG)

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_17.JPG)

*Вопрос: Какой тип адреса NAT является переведенным адресом?*

*Ответ: PAT для динамического пула NAT с использованием одного IP-адреса*

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_18.JPG)
 
*Вопрос: Чем отличаются выходные данные команды show ip nat translations из упражнения NAT?*

*Ответ: для проверки PAT используеются те же команды , что и для проверки статического и динамического NAT. Для двух и более внутренних узлов выделяется один и тот же ip адрес (внутренний глобальный адрес). Для различия транзакций в таблице NAT используются номера портов источников*

b.	С PC-A, запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_19.JPG)


Обратите внимание, что есть только одна трансляция. Отправьте ping еще раз, и быстро вернитесь к маршрутизатору и введите команду show ip nat translations verbose (команда не реализована в Cisco PT) , и вы увидите, что произошло.

c.	Генерирует трафик с нескольких устройств для наблюдения PAT. На PC-A и PC-B используйте параметр -t с командой ping, чтобы отправить безостановочный ping на интерфейс Lo1 R2 (ping -t 209.165.200.1), затем вернитесь к R1 и выполните команду show ip nat translations:

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_20.JPG)

Внутренний глобальный адрес одинаков для обоих сеансов. 

*Вопрос: Как маршрутизатор отслеживает, куда идут ответы?*

*Ответ: Маршрутизатор отслеживает внутренние и внешние локальные адреса, внутренние и внешние глобальные адреса, а также порты.*

d.	PAT в пул является очень эффективным решением для малых и средних организаций. Тем не менее есть неиспользуемые адреса IPv4, задействованные в этом сценарии. Мы перейдем к PAT с перегрузкой интерфейса, чтобы устранить эту трату IPv4 адресов. Остановите ping на PC-A и PC-B с помощью комбинации клавиш Control-C, затем очистите трансляции и статистику:

*R1# clear ip nat translations**
*R1# clear ip nat statistics* (команда не реализована в Cisco PT)

#### Шаг 4. На R1 удалите команды преобразования nat pool.

Опять же, наш список доступа (список доступа 1) по-прежнему корректен для сетевого сценария, поэтому нет необходимости воссоздавать его. Кроме того, внутренний и внешний интерфейсы не меняются. Чтобы начать работу с PAT к интерфейсу, очистите конфигурацию, удалив пул NAT и команду, связывающую ACL и пул вместе. Скрин ниже. 


#### Шаг 5. Добавьте команду PAT overload, указав внешний интерфейс.

Добавьте команду PAT, которая вызовет перегрузку внешнего интерфейса.

*R1(config)# ip nat inside source list 1 interface g0/0/0 overload*

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_21.JPG)

#### Шаг 6. Протестируйте и проверьте конфигурацию. 

a.	Давайте проверим PAT, чтобы интерфейс работал. С PC-B,  запустите эхо-запрос интерфейса Lo1 (209.165.200.1) на R2. Если эхо-запрос не прошел, выполните отладку. На R1 отобразите таблицу NAT на R1 с помощью команды *show ip nat translations.*

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_22.JPG)


b.	Сделайте трафик с нескольких устройств для наблюдения PAT. На PC-A и PC-B используйте параметр -t с командой ping для отправки безостановочного ping на интерфейс Lo1 R2 (ping -t 209.165.200.1). На S1 и S2 выполните привилегированную команду exec ping 209.165.200.1 повторить 2000. Затем вернитесь к R1 и выполните команду *show ip nat translations.*

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_23.JPG)


Теперь все внутренние глобальные адреса сопоставляются с IP-адресом интерфейса g0/0/0.

#### Часть 4. Настройка и проверка статического NAT для IPv4.

В части 4 будет настроена статическая NAT таким образом, чтобы PC-A был доступен напрямую из Интернета. PC-A будет доступен из R2 по адресу 209.165.200.229.
Примечание. Конфигурация, которую вы собираетесь завершить, не соответствует рекомендуемым практикам для шлюзов, подключенных к Интернету. Эта лаборатория полностью опускает стандартные методы безопасности, чтобы сосредоточиться на успешной конфигурации статического NAT. В производственной среде решающее значение для удовлетворения этого требования будет иметь тщательная координация между сетевой инфраструктурой и группами безопасности. 

#### Шаг 1. На R1 очистите текущие трансляции и статистику.

Скрин ниже

#### Шаг 2. На R1 настройте команду NAT, необходимую для статического сопоставления внутреннего адреса с внешним адресом.

Для этого шага настройте статическое сопоставление между 192.168.1.11 и 209.165.200.1. Скрин ниже

#### Шаг 3. Протестируйте и проверьте конфигурацию.

a.	Давайте проверим, что статический NAT работает. На R1 отобразите таблицу NAT на R1 с помощью команды *show ip nat translations*, и вы увидите статическое сопоставление.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_24.JPG)

b.	Таблица перевода показывает, что статическое преобразование действует. Проверьте это, запустив ping  с R2 на 209.165.200.229. Плинги должны работать. Скрин ниже

c.	На R1 отобразите таблицу NAT на R1 с помощью команды show ip nat translations, и вы увидите статическое сопоставление и преобразование на уровне порта для входящих pings.

![](https://github.com/AlexIridium/net_engineer_otus/blob/main/lab12/pic_25.JPG)


Это подтверждает, что статический NAT работает.
